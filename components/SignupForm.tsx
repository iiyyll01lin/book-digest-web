'use client';
import { useState } from 'react';
import { useTranslations } from 'next-intl';
import { z } from 'zod';

type Location = 'TW' | 'NL';

export type SignupFormProps = {
  location: Location;
  endpoint?: string;
};

// Move schema to module level for better performance (only created once)
const baseSchema = z.object({
  name: z.string().min(1, 'Name is required').max(100),
  age: z
    .string()
    .transform((v) => (v.trim() === '' ? NaN : Number(v)))
    .refine((n) => Number.isInteger(n) && n >= 13 && n <= 120, {
      message: 'Age must be an integer between 13 and 120',
    }),
  profession: z.string().min(1, 'Profession is required').max(120),
  email: z
    .string()
    .min(1, 'Email is required')
    .email('Please enter a valid email'),
  instagram: z.string().optional(),
  referral: z.enum(['Instagram', 'Facebook', 'Others']),
  referralOther: z.string().optional(),
  website: z.string().optional(),
});

// Pre-built schema with superRefine (module level, created once)
const formSchema = baseSchema.superRefine((data, ctx) => {
  if (data.referral === 'Others') {
    if (!data.referralOther || data.referralOther.trim().length < 2) {
      ctx.addIssue({
        code: z.ZodIssueCode.custom,
        path: ['referralOther'],
        message: 'Please specify at least 2 characters',
      });
    }
  }
});

export default function SignupForm({ location, endpoint }: SignupFormProps) {
  const t = useTranslations('form');
  const tEvents = useTranslations('events');
  const [submitting, setSubmitting] = useState(false);
  const [success, setSuccess] = useState<null | 'ok' | 'error'>(null);
  const [errors, setErrors] = useState<Record<string, string>>({});
  const [values, setValues] = useState({
    name: '',
    age: '',
    profession: '',
    email: '',
    instagram: '',
    referral: 'Instagram' as 'Instagram' | 'Facebook' | 'Others',
    referralOther: '',
    website: '',
  });

  const onChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const target = e.target as HTMLInputElement & HTMLSelectElement;
    const { name } = target;
    const isCheckbox = (target as HTMLInputElement).type === 'checkbox';
    const nextValue = isCheckbox ? (target as HTMLInputElement).checked : target.value;
    setValues((v) => ({ ...v, [name]: nextValue }));
    if (errors[name]) setErrors((prev) => ({ ...prev, [name]: '' }));
  };

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setSubmitting(true);
    setSuccess(null);

    const res = formSchema.safeParse(values);
    if (!res.success) {
      const fieldErrors: Record<string, string> = {};
      for (const issue of res.error.issues) {
        const key = issue.path[0] as string;
        if (!fieldErrors[key]) fieldErrors[key] = issue.message;
      }
      setErrors(fieldErrors);
      setSubmitting(false);
      return;
    }

    if (values.website && values.website.trim().length > 0) {
      setSuccess('ok');
      setSubmitting(false);
      setValues({
        name: '', age: '', profession: '', email: '', instagram: '', referral: 'Instagram', referralOther: '', website: ''
      });
      return;
    }

    try {
      if (endpoint) {
        const resp = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            location,
            name: values.name,
            age: Number(values.age),
            profession: values.profession,
            email: values.email,
            instagram: values.instagram || undefined,
            referral: values.referral,
            referralOther: values.referral === 'Others' ? values.referralOther : undefined,
            timestamp: new Date().toISOString(),
          }),
        });
        if (!resp.ok) throw new Error('Request failed');
      } else {
        await new Promise((r) => setTimeout(r, 800));
      }

      setSuccess('ok');
      setValues({
        name: '', age: '', profession: '', email: '', instagram: '', referral: 'Instagram', referralOther: '', website: ''
      });
    } catch {
      setSuccess('error');
    } finally {
      setSubmitting(false);
    }
  };

  // Unified white input style
  const inputClass = (hasError: boolean) =>
    `w-full rounded-lg bg-white px-4 py-3 text-gray-900 placeholder-gray-400 outline-none focus:ring-2 focus:ring-brand-pink transition-colors ${hasError ? 'ring-2 ring-red-400' : ''}`;

  // Location badge colors
  const locationBadgeClass = location === 'TW'
    ? 'bg-[#FFDD57] text-brand-navy'
    : 'bg-brand-pink text-brand-navy';

  return (
    <div>
      <div className="flex items-center gap-3 mb-6">
        <h3 className="text-lg font-semibold text-white">
          Sign up
        </h3>
        <span className={`px-4 py-1.5 rounded-full text-sm font-bold ${locationBadgeClass}`}>
          üìç {location === 'TW' ? tEvents('taiwan') : tEvents('netherlands')}
        </span>
      </div>

      {success === 'ok' ? (
        <div className="rounded-lg bg-emerald-500/15 border border-emerald-400/30 text-emerald-200 p-4" role="status">
          {t('success')}
        </div>
      ) : success === 'error' ? (
        <div className="rounded-lg bg-red-500/15 border border-red-400/30 text-red-200 p-4" role="status">
          {t('error')}
        </div>
      ) : null}

      <form className="space-y-5" onSubmit={handleSubmit} noValidate>
        {/* Honeypot */}
        <input type="text" name="website" value={values.website} onChange={onChange} className="hidden" tabIndex={-1} autoComplete="off" aria-hidden="true" />

        {/* Name */}
        <div>
          <label htmlFor="name" className="block text-sm font-medium text-white mb-2">{t('nameLabel')}</label>
          <input
            id="name" name="name" value={values.name} onChange={onChange}
            className={inputClass(!!errors.name)}
            autoComplete="name"
          />
          {errors.name && <p className="mt-1 text-xs text-red-300">{errors.name}</p>}
        </div>

        {/* Age */}
        <div>
          <label htmlFor="age" className="block text-sm font-medium text-white mb-2">{t('ageLabel')}</label>
          <input
            id="age" name="age" inputMode="numeric" pattern="[0-9]*" value={values.age} onChange={onChange}
            className={inputClass(!!errors.age)}
          />
          {errors.age && <p className="mt-1 text-xs text-red-300">{errors.age}</p>}
        </div>

        {/* Profession */}
        <div>
          <label htmlFor="profession" className="block text-sm font-medium text-white mb-2">{t('professionLabel')}</label>
          <input
            id="profession" name="profession" value={values.profession} onChange={onChange}
            className={inputClass(!!errors.profession)}
          />
          {errors.profession && <p className="mt-1 text-xs text-red-300">{errors.profession}</p>}
        </div>

        {/* Email */}
        <div>
          <label htmlFor="email" className="block text-sm font-medium text-white mb-2">{t('emailLabel')}</label>
          <input
            id="email" name="email" type="email" value={values.email} onChange={onChange}
            className={inputClass(!!errors.email)}
            autoComplete="email"
          />
          {errors.email && <p className="mt-1 text-xs text-red-300">{errors.email}</p>}
        </div>

        {/* Instagram */}
        <div>
          <label htmlFor="instagram" className="block text-sm font-medium text-white mb-2">{t('instagramLabel')}</label>
          <input
            id="instagram" name="instagram" value={values.instagram} onChange={onChange}
            className={inputClass(false)}
            placeholder="bookdigest_tw"
          />
        </div>

        {/* Referral */}
        <div>
          <label htmlFor="referral" className="block text-sm font-medium text-white mb-2">{t('referralLabel')}</label>
          <select
            id="referral" name="referral" value={values.referral} onChange={onChange}
            className={`${inputClass(false)} appearance-none bg-[url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22none%22%20viewBox%3D%220%200%2024%2024%22%20stroke%3D%22%23666%22%3E%3Cpath%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%222%22%20d%3D%22M19%209l-7%207-7-7%22%2F%3E%3C%2Fsvg%3E')] bg-no-repeat bg-[right_1rem_center] bg-[length:1.25rem]`}
          >
            <option value="Instagram">Instagram</option>
            <option value="Facebook">Facebook</option>
            <option value="Others">{t('referralOthers')}</option>
          </select>
        </div>

        {/* Reserve space for referralOther to prevent layout shift */}
        <div className={`transition-all duration-200 overflow-hidden ${values.referral === 'Others' ? 'max-h-24 opacity-100' : 'max-h-0 opacity-0'}`}>
          <div>
            <label htmlFor="referralOther" className="block text-sm font-medium text-white mb-2">{t('referralOtherLabel')}</label>
            <input
              id="referralOther" name="referralOther" value={values.referralOther} onChange={onChange}
              className={inputClass(!!errors.referralOther)}
              placeholder={t('referralOtherPlaceholder')}
            />
            {errors.referralOther && <p className="mt-1 text-xs text-red-300">{errors.referralOther}</p>}
          </div>
        </div>

        {/* Submit */}
        <div className="pt-4">
          <button
            type="submit"
            disabled={submitting}
            className="inline-flex items-center rounded-full bg-brand-pink text-brand-navy px-6 py-2.5 font-semibold shadow hover:brightness-110 transition-all disabled:opacity-60"
          >
            {submitting ? t('submitting') : t('submit')}
          </button>
        </div>
      </form>
    </div>
  );
}
